/**
 * OrgPage.jsx - –ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ NotesTabForm
 * 
 * –ü–æ–∫–∞–∑—ã–≤–∞—é —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —á–∞—Å—Ç–∏ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤–∫–ª–∞–¥–∫–∏ –∑–∞–º–µ—Ç–æ–∫.
 * –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º:
 *   - NotesTabForm: ./components/forms/NotesTabForm
 *   - –°—Ç–∏–ª–∏: ./components/style/orgpage-forms.css
 */

import React, { useState, useEffect, useCallback, useRef } from 'react';
import { useParams, useSearchParams, useNavigate } from 'react-router-dom';
import { Form, Button, message, Modal, Affix, Tag, Tooltip } from 'antd';
import { 
  PencilIcon, 
  XMarkIcon, 
  ClipboardDocumentCheckIcon 
} from '@heroicons/react/24/outline';
import { LoadingOutlined } from '@ant-design/icons';

import { CSRF_TOKEN, PRODMODE } from '../../config/config';
import { PROD_AXIOS_INSTANCE } from '../../config/Api';

// ===================== –§–û–†–ú–´ –í–ö–õ–ê–î–û–ö =====================
// –ù–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞ antd Form
import NotesTabForm, { collectNotesForSave } from './components/forms/NotesTabForm';
import ProjectsTabForm, { collectProjectsForSave } from './components/forms/ProjectsTabForm';
// import CallsTabForm, { collectCallsForSave } from './components/forms/CallsTabForm';
// import MainTabForm from './components/forms/MainTabForm';

// –°—Ç–∞—Ä—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–ø–æ–∫–∞ –Ω–µ –ø–µ—Ä–µ–ø–∏—Å–∞–Ω—ã)
import OrgListModalBillsTab from '../ORG_LIST/components/OrgModal/Tabs/OrgListModalBillsTab';
import OrgListModalOffersTab from '../ORG_LIST/components/OrgModal/Tabs/OrgListModalOffersTab';
import OrgListModalHistoryTab from '../ORG_LIST/components/OrgModal/Tabs/OrgListModalHistoryTab';

// –°—Ç–∏–ª–∏
import './components/style/orgpage-forms.css';

const TAB_CONFIG = [
  { key: 'm', label: '–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è' },
  { key: 'b', label: '–°—á–µ—Ç–∞' },
  { key: 'o', label: '–ö–ü' },
  { key: 'p', label: '–ü—Ä–æ–µ–∫—Ç—ã' },
  { key: 'c', label: '–í—Å—Ç—Ä–µ—á–∏/–ó–≤–æ–Ω–∫–∏' },
  { key: 'n', label: '–ó–∞–º–µ—Ç–∫–∏' },
  { key: 'h', label: '–ò—Å—Ç–æ—Ä–∏—è' },
];

const OrgPage = ({ userdata }) => {
  const { item_id } = useParams();
  const [searchParams, setSearchParams] = useSearchParams();

  // ===================== –§–û–†–ú–´ (–ø–æ –æ–¥–Ω–æ–π –Ω–∞ –≤–∫–ª–∞–¥–∫—É) =====================
  const [mainForm] = Form.useForm();
  const [projectsForm] = Form.useForm();
  const [notesForm] = Form.useForm();
  const [callsForm] = Form.useForm();

  // ===================== –°–û–°–¢–û–Ø–ù–ò–Ø =====================
  const [orgId] = useState(item_id ? parseInt(item_id) : null);
  const [activeTab, setActiveTab] = useState('m');
  const [editMode, setEditMode] = useState(false);
  const [saving, setSaving] = useState(false);
  const [orgName, setOrgName] = useState('');
  const [selects, setSelects] = useState(null);      // –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤
  const [orgContacts, setOrgContacts] = useState([]); // –ö–æ–Ω—Ç–∞–∫—Ç—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
  
  // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ –≤–∫–ª–∞–¥–∫–∞–º
  const [changedTabs, setChangedTabs] = useState({
    m: false, p: false, c: false, n: false,
  });

  // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏)
  const originalDataRef = useRef({
    notes: [],
    projects: [],
    calls: [],
  });

  const hasChanges = Object.values(changedTabs).some(Boolean);

  // ===================== CALLBACK –û–¢ –î–û–ß–ï–†–ù–ò–• –§–û–†–ú =====================
  const handleDataChange = useCallback((tabKey, hasChanges) => {
    setChangedTabs(prev => ({ ...prev, [tabKey]: hasChanges }));
  }, []);

  // ===================== –°–û–•–†–ê–ù–ï–ù–ò–ï =====================
  const handleSave = async () => {
    setSaving(true);
    
    try {
      // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ –≤—Å–µ—Ö —Ñ–æ—Ä–º
      const payload = {
        notes: collectNotesForSave(notesForm, originalDataRef.current.notes),
        projects: collectProjectsForSave(projectsForm, originalDataRef.current.projects),
        // calls: collectCallsForSave(callsForm, originalDataRef.current.calls),
        // main: mainForm.getFieldsValue(),
      };
      
      console.log('üì§ Payload:', payload);
      
      if (PRODMODE) {
        const response = await PROD_AXIOS_INSTANCE.put(
          `/api/sales/v2/updateorglist/${orgId}`,
          { data: payload, _token: CSRF_TOKEN }
        );
        
        if (response.status === 200) {
          message.success('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
          setChangedTabs({ m: false, p: false, c: false, n: false });
        } else {
          message.error(response.data?.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        }
      } else {
        // DEV MODE
        console.log('üß™ DEV: Payload', payload);
        await new Promise(r => setTimeout(r, 1000));
        message.success('DEV: –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
        setChangedTabs({ m: false, p: false, c: false, n: false });
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞:', error);
      message.error(error.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    } finally {
      setSaving(false);
    }
  };

  // ===================== –û–¢–ú–ï–ù–ê =====================
  const handleDiscard = () => {
    notesForm.resetFields();
    projectsForm.resetFields();
    // callsForm.resetFields();
    // mainForm.resetFields();
    setChangedTabs({ m: false, p: false, c: false, n: false });
    setEditMode(false);
  };

  // ===================== –¢–ê–ë–´ =====================
  const handleTabChange = (tabKey) => {
    setActiveTab(tabKey);
    searchParams.set('tab', tabKey);
    setSearchParams(searchParams);
  };

  // ===================== –†–ï–ù–î–ï–† =====================
  return (
    <div className="app-page">
      <div className="sa-orgpage-body sa-mw-1400">
        
        {/* Header */}
        <Affix offsetTop={0}>
          <div className="sa-orgpage-header">
            <div className="sa-flex-space">
              <div className="sa-orgpage-header-title">
                –ü–∞—Å–ø–æ—Ä—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ ({orgId}) / {TAB_CONFIG.find(t => t.key === activeTab)?.label}
              </div>
              <div className="sa-orp-menu">
                {TAB_CONFIG.map(tab => (
                  <div
                    key={tab.key}
                    className={`sa-orp-menu-button 
                      ${activeTab === tab.key ? 'active' : ''}
                      ${changedTabs[tab.key] ? 'sa-mite-has-some' : ''}
                    `}
                    onClick={() => handleTabChange(tab.key)}
                  >
                    {tab.label}
                  </div>
                ))}
              </div>
            </div>
          </div>
        </Affix>

        {/* Sub-header */}
        <Affix offsetTop={36}>
          <div className="sa-orgpage-sub-header sa-flex-space">
            <div className="sa-orgpage-sub-name">{orgName || '...'}</div>
            <div className="sa-flex sa-orgpage-sub-control">
              {editMode && hasChanges && (
                <Tooltip title="–ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å">
                  <Tag color="red-inverse">–ù–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</Tag>
                </Tooltip>
              )}
              
              {editMode ? (
                <>
                  <Button
                    type="primary"
                    icon={saving ? <LoadingOutlined /> : <ClipboardDocumentCheckIcon height={16} />}
                    onClick={handleSave}
                    disabled={!hasChanges || saving}
                    loading={saving}
                  >
                    {saving ? '–°–æ—Ö—Ä–∞–Ω—è—é...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}
                  </Button>
                  <Button
                    icon={<XMarkIcon height={16} />}
                    onClick={() => hasChanges 
                      ? Modal.confirm({
                          title: '–û—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è?',
                          onOk: handleDiscard,
                        }) 
                      : setEditMode(false)
                    }
                  >
                    –ó–∞–∫—Ä—ã—Ç—å
                  </Button>
                </>
              ) : (
                <Button icon={<PencilIcon height={16} />} onClick={() => setEditMode(true)}>
                  –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </Button>
              )}
            </div>
          </div>
        </Affix>

        {/* –ö–æ–Ω—Ç–µ–Ω—Ç */}
        <div className="sa-outlet-body">
          
          {activeTab === 'b' && <OrgListModalBillsTab data={{ id: orgId }} environment="editor" org_name={orgName} />}
          {activeTab === 'o' && <OrgListModalOffersTab data={{ id: orgId }} environment="editor" org_name={orgName} />}
          {activeTab === 'm' && <div>TODO: MainTabForm</div>}
          
          {/* ‚úÖ –ü–†–û–ï–ö–¢–´ */}
          <ProjectsTabForm
            form={projectsForm}
            orgId={orgId}
            editMode={editMode}
            isActive={activeTab === 'p'}
            userdata={userdata}
            selects={selects}
            orgContacts={orgContacts}
            onDataChange={handleDataChange}
          />
          
          {activeTab === 'c' && <div>TODO: CallsTabForm</div>}
          
          {/* ‚úÖ –ó–ê–ú–ï–¢–ö–ò */}
          <NotesTabForm
            form={notesForm}
            orgId={orgId}
            editMode={editMode}
            isActive={activeTab === 'n'}
            userdata={userdata}
            onDataChange={handleDataChange}
          />
          
          {activeTab === 'h' && <OrgListModalHistoryTab data={{ id: orgId }} environment="editor" />}
        </div>
      </div>
    </div>
  );
};

export default OrgPage;
